#!/bin/bash

# Usage: ./sim <benchmark_name> [config_file]
# Example: ./sim qsort
# Example: ./sim alu_fp_add hardware/configs/cache_high_assoc.toml

TEST_NAME=$1
CONFIG=${2:-"hardware/configs/default.toml"}

if [ -z "$TEST_NAME" ]; then
    echo "Usage: ./sim <benchmark_name> [config_file]"
    echo "Available User Apps:"
    ls software/bin/user | sed 's/.bin//g' | sed 's/^/  - /'
    echo "Available Benchmarks:"
    ls software/bin/benchmarks | sed 's/.bin//g' | sed 's/^/  - /'
    exit 1
fi

# Check User Apps
if [ -f "software/bin/user/$TEST_NAME.bin" ]; then
    BIN_PATH="software/bin/user/$TEST_NAME.bin"
# Check benchmarks
elif [ -f "software/bin/benchmarks/$TEST_NAME.bin" ]; then
    BIN_PATH="software/bin/benchmarks/$TEST_NAME.bin"
# Check Legacy/Root bin
elif [ -f "software/bin/$TEST_NAME.bin" ]; then
    BIN_PATH="software/bin/$TEST_NAME.bin"
else
    echo "Error: Binary '$TEST_NAME.bin' not found in software/bin/user/ or software/bin/benchmarks/."
    echo "Did you run 'make'?"
    exit 1
fi

echo "--------------------------------------------------"
echo "Running: $TEST_NAME"
echo "Binary:  $BIN_PATH"
echo "Config:  $CONFIG"
echo "--------------------------------------------------"

# Run the emulator
cargo run --quiet --manifest-path hardware/Cargo.toml --release -- \
    --config "$CONFIG" \
    --file "$BIN_PATH"
